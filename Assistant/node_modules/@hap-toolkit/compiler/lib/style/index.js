"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_css=_interopRequireDefault(require("css")),_cssWhat=_interopRequireDefault(require("css-what")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_validator=require("./validator"),_compress=require("./compress"),_utils=require("../utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function processImport(e,t,s,o){let a=e;const n=e.match(/@import\s+((?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\))))\s*;/g);return n&&n.length>0&&(t?n.forEach(e=>{const n=e.match(/(?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\)))/);if(n.length>1){const r=_path.default.resolve(t,n[1]||n[2]),i=_fs.default.readFileSync(r);if(i){const t=_path.default.dirname(r);a=a.replace(e,"\n"+processImport(i.toString(),t,s,o)+"\n"),o.push(r)}else s.push({line:1,column:1,reason:"ERROR: 找不到文件 `"+e+"` , 导入失败"})}}):s.push({line:1,column:1,reason:"ERROR: 找不到资源路径, 无法处理@import"})),a}function shouldAddToDependency(e,t){return(0,_validator.mightReferlocalResource)(e)&&!/^(data:|http)/.test(t)&&"string"==typeof t}function parse(e){let t;const s={},o=[];let a=[],n=e.code||"";const r=e.filePath,i=[];n=processImport(n,_path.default.dirname(r),o,i);const l=_css.default.parse(n,{silent:!0});return l.stylesheet.parsingErrors&&l.stylesheet.parsingErrors.length&&(t=l.stylesheet.parsingErrors).forEach(function(e){o.push({line:e.line,column:e.column,reason:e.toString()})}),l&&"stylesheet"===l.type&&l.stylesheet&&l.stylesheet.rules&&l.stylesheet.rules.length&&l.stylesheet.rules.forEach(function(e){const t=e.type,n={};if("rule"===t){if(e.declarations&&e.declarations.length){e.declarations.forEach(function(e){if("declaration"!==e.type)return;const t=e.property,s=e.value,i=(0,_utils.hyphenedToCamelCase)(t),l=(0,_validator.validate)(i,s,{filePath:r});l.value.forEach(e=>{(0,_utils.isValidValue)(e.v)&&(n[e.n]=e.v,shouldAddToDependency(e.n,e.v)&&a.push(e.v))}),l.log&&o.push({line:e.position.start.line,column:e.position.start.column,reason:l.log.reason})});const t=/^[.#]?[A-Za-z0-9_\-:]+$/,i=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/;e.selectors.forEach(function(a){const r={key:a,val:n};if(a.match(t)||a.match(i)){if(!processPseudoClass(r,o,e))return;if(s[r.key]&&a===r.key&&!(0,_utils.equals)(s[r.key],r.val,cssCompare)&&o.push({line:e.position.start.line,column:e.position.start.column,reason:"WARN: 选择器 `"+r.key+"` 已经存在，后者合并前者"}),!_compilationConfig.options.optimizeDescMeta&&a.match(i))try{r.val=Object.assign({},r.val),r.val._meta={},r.val._meta.ruleDef=(0,_compress.compressDescSelector)((0,_cssWhat.default)(r.key))}catch(t){return void o.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+r.key+"` 不支持"})}s[r.key]=(0,_utils.extend)({},s[r.key]||{},r.val)}else o.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+a+"` 非法"})})}}else if("font-face"===t){if(e.declarations&&e.declarations.length){const t={};e.declarations.forEach(function(e){if("declaration"!==e.type)return;const s=(0,_utils.hyphenedToCamelCase)(e.property),n=e.value;if("fontFamily"===s)t.fontName=n.replace(/['"]+/g,"");else if("src"===s){const s=(0,_validator.validate)("fontSrc",n,{filePath:r});s.log&&o.push({line:e.position.start.line,column:e.position.start.column,reason:s.log.reason}),t.fontSrc=s.value;const i=s.value||[];a=a.concat(i)}}),s["@FONT-FACE"]||(s["@FONT-FACE"]={}),s["@FONT-FACE"][t.fontName]=t}}else if("keyframes"===t&&e.keyframes&&e.keyframes.length){const t=e.name,n=[];e.keyframes.forEach(function(s){let i;if("keyframe"===s.type&&s.declarations&&s.declarations.length)if(i={},s.declarations.forEach(function(e){if("declaration"!==e.type)return;const t=e.property,s=e.value,n=(0,_utils.hyphenedToCamelCase)(t),l=(0,_validator.validate)(n,s,{filePath:r});l.value.forEach(e=>{(0,_utils.isValidValue)(e.v)&&(i[e.n]=e.v,shouldAddToDependency(e.n,e.v)&&a.push(e.v))}),l.log&&o.push({line:e.position.start.line,column:e.position.start.column,reason:l.log.reason})}),(0,_utils.isEmptyObject)(i))o.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 动画 `"+t+"` 的关键帧 `"+JSON.stringify(s.values)+"` 没有有效的属性"});else{let e;s.values.forEach(t=>{e="from"===t?0:"to"===t?100:parseFloat(t.replace("%","")),i.time=e,n.push(i)})}}),n.sort(function(e,t){return e.time-t.time}),s["@KEYFRAMES"]||(s["@KEYFRAMES"]={}),s["@KEYFRAMES"][t]=n}}),_compilationConfig.options.optimizeCssAttr&&(0,_compress.compressCssAttr)(s),{jsonStyle:s,depList:i,log:o,depFiles:a}}function processPseudoClass(e,t,s){const o=e.key.indexOf(":");if(o>-1){const a=e.key.slice(o);if(!(0,_validator.validatePseudoClass)(a))return t.push({line:s.position.start.line,column:s.position.start.column,reason:"ERROR: 不支持伪类选择器`"+a+"`"}),!1;e.key=e.key.slice(0,o);const n={};Object.keys(e.val).forEach(function(t){n[t+a]=e.val[t]}),e.val=n}return!0}function cssCompare(e,t,s){if("_meta"===s)return!0}var _default={parse:parse,validateDelaration:_validator.validate,mightReferlocalResource:_validator.mightReferlocalResource,shouldAddToDependency:shouldAddToDependency};exports.default=_default;
//# sourceMappingURL=index.js.map
