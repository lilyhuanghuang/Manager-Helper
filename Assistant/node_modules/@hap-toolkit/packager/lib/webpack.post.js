"use strict";const fs=require("fs"),path=require("path"),globalConfig=require("@hap-toolkit/shared-utils/config"),{initOptions:initOptions,options:compileOptions}=require("@hap-toolkit/shared-utils/compilation-config"),CopyDslPlugin=require("./plugin/copy-dsl-plugin"),HandlerPlugin=require("./plugin/handler-plugin"),ResourcePlugin=require("./plugin/resource-plugin"),ZipPlugin=require("./plugin/zip-plugin"),NotifyPlugin=require("./plugin/notify-plugin"),{colorconsole:colorconsole,loadBabelModule:loadBabelModule}=require("./common/utils");function genPriorities(e){const o=["manifest.json","app.js",/^common\//i];if(e&&e.router&&e.router.entry){const i=e.router.entry;o.splice(2,0,new RegExp(`^${i}/$`),new RegExp(`^${i}/.+`))}else colorconsole.error("manifest.json 中未配置入口页面 router.entry");return o}function getManifest(e){let o;try{const i=fs.readFileSync(e).toString();o=JSON.parse(i)}catch(e){colorconsole.error(`读取 manifest.json 失败： ${e.message}`)}return o||{}}function resolveLoader(e){return require.resolve(`./loader/${e}`)}function postHook(e,o,i){const n=globalConfig.projectPath,{appPackageName:r,versionCode:t,pathDist:s,pathBuild:l,pathSignFolder:a,pathSrc:p,subpackages:u,workers:c}=o;initOptions(i);const g=getManifest(path.join(p,"manifest.json")),d=genPriorities(g);e.module.rules.push({test:/\.js$/,use:[resolveLoader("module-loader.js"),{loader:loadBabelModule("babel-loader"),options:{cwd:n}}]},{test:/\.(png|jpe?g|gif|svg|bmp|webp|mp4|wmv|avi|mpg|rmvb|mov|flv|otf|ttf|ttc|woff|eot)$/i,use:{loader:require.resolve("file-loader"),options:{publicPath:e=>{const o=/^src/;return o.test(e)?e.replace(o,""):"/"+e},context:n,name:"[path][name].[ext]",emitFile:!1}}});const m="dev"===process.env.NODE_PHASE&&i.sign,f="dev"!==process.env.NODE_PHASE&&!i.debug,h=m||f,b=h?"release":"debug",P=JSON.stringify({toolkit:require("../package.json").version,timeStamp:(new Date).toJSON(),node:process.version,platform:process.platform,arch:process.arch,extends:i.packageExtends||null});if(i.includeDslFromLib&&e.plugins.unshift(new CopyDslPlugin({cwd:n,config:g.config})),e.plugins.push(new HandlerPlugin({pathSrc:p,workers:c}),new ResourcePlugin({src:p,dest:l,sign:h,projectRoot:globalConfig.projectPath,optimizeUnusedResource:i.optimizeUnusedResource}),new ZipPlugin({name:r,versionCode:t,output:s,pathBuild:l,pathSignFolder:a,sign:b,priorities:d,subpackages:u,comment:P,cwd:n,disableStreamPack:i.disableStreamPack,disableSubpackages:i.disableSubpackages}),new NotifyPlugin),compileOptions.stats){const o=require("webpack-bundle-analyzer").BundleAnalyzerPlugin;e.plugins.push(new o({analyzerMode:"static",openAnalyzer:!1}))}}module.exports={postHook:postHook};
//# sourceMappingURL=webpack.post.js.map
