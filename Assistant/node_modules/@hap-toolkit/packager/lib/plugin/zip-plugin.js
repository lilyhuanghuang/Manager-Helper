"use strict";var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_sharedUtils=require("@hap-toolkit/shared-utils"),_config=_interopRequireDefault(require("@hap-toolkit/shared-utils/config")),_utils=require("../common/utils"),_rpks=require("../subpackages/rpks");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function resolveFiles(e,t){let i=(0,_utils.lsdirdeep)(e);return i.includes(_rpks.DIGEST_ZIP_PATH)?(console.warning(`检测到存在快应用保留文件: ${_rpks.DIGEST_ZIP_PATH}`),!1):i=(0,_utils.sortFilesBy)(i,t)}function ZipPlugin(e){this.options=Object.assign({priorities:["manifest.json","app.js"]},e);const t=e.cwd||_config.default.projectPath,i=e.pathSignFolder||"sign",s={debug:{privatekey:_path.default.join(t,i,"debug/private.pem"),certificate:_path.default.join(t,i,"debug/certificate.pem")},release:{privatekey:_path.default.join(t,i,"release/private.pem"),certificate:_path.default.join(t,i,"release/certificate.pem")}};function r(){process.nextTick(()=>{process.exit(1)})}if(this.pemFiles=s[e.sign],!this.pemFiles)return void _sharedUtils.colorconsole.error("> 无签名配置项, 放弃打包: ",e.sign);const{privatekey:a,certificate:o}=this.pemFiles;_fs.default.existsSync(a)||(_sharedUtils.colorconsole.error("> 缺少私钥文件, 打包失败: ",(0,_sharedUtils.relateCwd)(a)),r()),_fs.default.existsSync(o)||(_sharedUtils.colorconsole.error("> 缺少证书文件, 打包失败: ",(0,_sharedUtils.relateCwd)(o)),r())}function generateDistFile(e,t,i,s){const r=`${t.name}.${t.sign}.${s}`,a=_path.default.join(t.output,r);_fs.default.writeFileSync(a,e),_sharedUtils.colorconsole.log(`### App Loader ### ${(0,_sharedUtils.relateCwd)(t.output)}目录签名并生成${s}文件：${r}`)}ZipPlugin.prototype.apply=function(e){const t=this.options;if(!this.pemFiles)return void _sharedUtils.colorconsole.error("> 无签名配置项, 放弃打包: ",t.sign);let i;!t.disableSubpackages&&t.subpackages&&t.subpackages.length>0&&(i=t.subpackages),e.hooks.afterEmit.tapAsync("ZipPlugin",(s,r)=>{const{privatekey:a,certificate:o}=this.pemFiles,l=_fs.default.readFileSync(a),n=_fs.default.readFileSync(o),p=resolveFiles(t.pathBuild,t.priorities);if(!1===p)return void r();const{fullPackage:u,subPackages:c}=(0,_rpks.createPackagesDefinition)(i);(0,_rpks.allocateResourceToPackages)(p,t.pathBuild,u,c),(0,_rpks.signZipPkgs)(t.name,l,n,u,c,t.comment,t.disableStreamPack).then(({rpksBuffer:i,rpkBuffer:s})=>{_fs.default.mkdir(t.output,()=>{i&&generateDistFile(i,t,e.watchMode,"rpks"),generateDistFile(s,t,e.watchMode,"rpk"),r()})})})},module.exports=ZipPlugin;
//# sourceMappingURL=zip-plugin.js.map
